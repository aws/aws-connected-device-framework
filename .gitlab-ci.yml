# Official framework image. Look for the different tagged releases at: https://hub.docker.com/r/library/node/tags/
image: public.ecr.aws/lambda/nodejs:14

stages:
  - build
  - test

cache:  
  # enable per-branch caching
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - common/
    - packages/**/.rush/
    - packages/**/dist/
    - packages/**/tsconfig.tsbuildinfo

before_script:
  - env | sort
  # install openssl (required to test some services)
  - yum install -y openssl zip
  # install git (required for `rush change`)
  - yum update -y
  - yum install git -y
  - git version

build:
  stage: build
  script:
    # install dependencies
    - node common/scripts/install-run-rush.js install --bypass-policy --purge
    # enforce need for changelog
    - node common/scripts/install-run-rush.js change -v
    # build
    - node common/scripts/install-run-rush.js rebuild

test:
  stage: test
  script:
    - env | sort
    # test
    - ls
    - cat common/config/rush/command-line.json
    - node common/scripts/install-run-rush.js test
    # version projects that have changed
    - node common/scripts/install-run-rush.js publish -a
