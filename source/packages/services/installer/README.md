# Getting Started

The `installer` module provides a set of tools for installing and managing CDF modules.

## Prerequisite

### CDF Module Bundles

Ensure that CDF modules had been built and bundled ready for deployment.

```shell
aws-connected-device-framework/source> rush install
aws-connected-device-framework/source> rush bundle
```

### IAM Credentials

The installer executes a number of aws commands (e.g, `aws cloudformation package`, `aws cloudformation deploy`) to upload artifacts and deploy the modules to the target account. Ensure that you have IAM credential with the right policies set up on your shell when running the scripts below.

## Build

To build the installer module run this script

```shell
aws-connected-device-framework/source> cd packages/services/installer
aws-connected-device-framework/source/packages/services/installer> rushx create:installer
```

## Commands

### Deploying using the wizard

Start the deployment wizard using the following command:

```shell
> cdf-cli deploy <environment> <region>
```

| Argument        | Description                       |
| --------------- | --------------------------------- |
| ``environment`` | the environment to deploy |
| ``region``      | the region to deploy into      |

The deployment wizard will ask a series of questions to determine which CDF modules need to be deployed based on the selected options. Once you finish the deployment, a configuration file for your deployment state will be stored in ``~/aws-connected-device-framework/config/<ACCOUNT_ID>/<REGION>/<ENVIRONMENT>``, ``ENVIRONMENT`` will be the file name. It is recommended to add these generated configuration files to source control so that others can update the deployment.

### Deploying using an existing configuration

The installer wizard can be bypassed by providing a pre-existing installer configuration file, the same file generated from the using the installer wizard, as follows:

| Argument              | Description                                                  |
| --------------------- | ------------------------------------------------------------ |
| ``environment`` | the environment to deploy |
| ``region``      | the region to deploy into      |
| ``deployment-config`` | location of deployment configuration file generated by deployment wizard |

```shell
> cdf-cli deploy <environment> <region> -c <deployment-config>
```

This will deploy all the modules configured in your last deployment wizard run. This type of deployment is recommended for continuous integration and automated deployments.

### Deleting stacks

This will remove all the stacks that have been created based on a deployment:

| Argument        | Description                       |
| --------------- | --------------------------------- |
| ``environment`` | the environment to deploy |
| ``region``      | the region to deploy into      |

```shell
> cdf-cli delete <environment> <region>
```

### Generating Postman environment file

This retrieves the urls for all the CDF modules that expose a REST API endpoint and prints out an [environment](https://learning.postman.com/docs/sending-requests/managing-environments/#creating-environments) json file that can be imported into [Postman](https://www.postman.com/product/rest-client/).

| Argument              | Description                                                  |
| --------------------- | ------------------------------------------------------------ |
| ``name``              | name of Postman environment                                  |
| ``environment`` | the environment to deploy |
| ``region``      | the region to deploy into      |

```shell
> cdf-cli postman <name> <environment> <region>
```

### Local development

You can generate the ``env`` file automatically for all the modules by running the following command:

| Argument              | Description                                                  |
| --------------------- | ------------------------------------------------------------ | 
| ``environment`` | the environment to deploy |
| ``region``      | the region to deploy into      |
| ``deployment-config`` | deployment configuration file generated by deployment wizard |
| ``output-folder``     | the folder to store the generated env file(s)                |

```shell
> cdf-cli config-to-env <environment> <region> <deployment-config> <output-folder>
```

The `.env` file for each of the deployed modules will be generated in the `output-folder`.

If you want to run the module locally, you need to specify the ``CONFIG_LOCATION`` environment variable when starting the module. As an example, if you want to run the provisioning module locally:

```shell
aws-connected-device-framework/source/packages/services/provisioning> export CONFIG_LOCATION=<path-to-provisioning-env-file>; npm run start
```
